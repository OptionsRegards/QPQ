<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Global Business Map</title>
    <!-- Leaflet core -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <!-- Marker clustering (optional but recommended for many points) -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- Simple, clean styles -->
    <style>
      :root {
        --bg: #0f172a; /* slate-900 */
        --panel: #111827cc; /* translucent */
        --text: #e5e7eb; /* gray-200 */
        --accent: #60a5fa; /* blue-400 */
      }
      html, body { height: 100%; margin: 0; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }
      #map { height: 100vh; width: 100%; }

      .app-header {
        position: fixed; z-index: 1000; top: 12px; left: 50%; transform: translateX(-50%);
        background: var(--panel); backdrop-filter: blur(6px);
        border: 1px solid #1f2937; border-radius: 16px; padding: 8px 14px;
        display: flex; gap: 10px; align-items: center;
        box-shadow: 0 8px 24px rgba(0,0,0,.35);
      }
      .app-header h1 { font-size: 15px; margin: 0; letter-spacing: .2px; font-weight: 600; }
      .app-header .subtitle { font-size: 12px; opacity: .8; }

      .control-panel {
        position: fixed; z-index: 1000; top: 64px; right: 12px;
        background: var(--panel); backdrop-filter: blur(6px);
        border: 1px solid #1f2937; border-radius: 16px; padding: 10px 12px; min-width: 220px;
        box-shadow: 0 8px 24px rgba(0,0,0,.35);
      }
      .control-panel h2 { font-size: 13px; margin: 0 0 6px; font-weight: 700; }
      .control-panel .row { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin: 6px 0; }
      .control-panel input[type="search"] { width: 100%; padding: 6px 8px; border-radius: 10px; border: 1px solid #374151; background: #111827; color: var(--text); }
      .pill {
        display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; margin: 4px 4px 0 0;
        background: #0b1220; border: 1px solid #1f2937; border-radius: 999px; font-size: 12px;
        cursor: pointer; user-select: none;
      }
      .pill input { accent-color: var(--accent); }
      .footnote { font-size: 11px; opacity: .75; margin-top: 8px; }

      .leaflet-container { background: #0b1020; }
      .leaflet-control-attribution { background: rgba(17, 24, 39, .6); color: #cbd5e1; }
      .leaflet-popup-content { color: #0b1220; }
      a { color: var(--accent); }
    </style>
  </head>
  <body>
    <div class="app-header" role="banner" aria-label="Global Business Map">
      <h1>Global Business Map</h1>
      <div class="subtitle">Host on GitHub Pages • Add points in <code>data/locations.json</code></div>
    </div>

    <!-- Filter/search panel -->
    <div class="control-panel" id="controls" aria-label="Map controls">
      <h2>Filters</h2>
      <div class="row"><input id="searchBox" type="search" placeholder="Search name…" aria-label="Search businesses" /></div>
      <div id="categoryPills" class="pills"></div>
      <div class="row"><button id="resetBtn" aria-label="Reset filters">Reset</button></div>
      <div class="footnote">Data file: <code>data/locations.json</code> (no API key needed)</div>
    </div>

    <div id="map" role="region" aria-label="Interactive world map"></div>

    <script>
      // --- 1) Base map ---
      const map = L.map('map', { worldCopyJump: true }).setView([20, 0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // Cluster group for lots of points
      const clusterGroup = L.markerClusterGroup({
        chunkedLoading: true,
        showCoverageOnHover: false,
        maxClusterRadius: 50,
      });
      map.addLayer(clusterGroup);

      // Keep references for filtering
      let allMarkers = []; // { marker, data }
      let activeCategories = new Set(); // empty => show all

      // --- 2) Load your data ---
      // Preferred path: /data/locations.json
      // Schema: [ { name, lat, lng, category, address?, url? } ]
      async function loadData() {
        try {
          const res = await fetch('data/locations.json', { cache: 'no-store' });
          if (!res.ok) throw new Error('Missing data/locations.json, using sample');
          const json = await res.json();
          initialize(json);
        } catch (err) {
          console.warn(err.message);
          const sample = [
            { name: 'Unconsolidated HQ', lat: 43.1566, lng: -77.6088, category: 'Analytics', address: 'Rochester, NY, USA', url: 'https://example.com' },
            { name: 'Nexus Foods', lat: 34.0522, lng: -118.2437, category: 'Consumer', address: 'Los Angeles, CA, USA' },
            { name: 'EuroTech GmbH', lat: 52.52, lng: 13.405, category: 'Technology', address: 'Berlin, Germany' },
            { name: 'Aussie Mining Ltd', lat: -31.9535, lng: 115.857, category: 'Materials', address: 'Perth, Australia' },
            { name: 'Sakura Finance', lat: 35.6762, lng: 139.6503, category: 'Financials', address: 'Tokyo, Japan' },
          ];
          initialize(sample);
        }
      }

      function initialize(points) {
        // Build category set from data
        const cats = Array.from(new Set(points.map(p => p.category).filter(Boolean))).sort();
        renderCategoryPills(cats);

        // Build markers
        allMarkers = points.map(p => {
          const marker = L.marker([p.lat, p.lng], { title: p.name });
          marker.bindPopup(renderPopupHTML(p));
          return { marker, data: p };
        });

        // Add to cluster and fit
        refreshMarkers();
        if (allMarkers.length) {
          const group = L.featureGroup(allMarkers.map(m => m.marker));
          try { map.fitBounds(group.getBounds().pad(0.2)); } catch (_) {}
        }

        // Wire up search and reset
        document.getElementById('searchBox').addEventListener('input', refreshMarkers);
        document.getElementById('resetBtn').addEventListener('click', () => {
          activeCategories.clear();
          document.querySelectorAll('#categoryPills input[type="checkbox"]').forEach(cb => cb.checked = false);
          const s = document.getElementById('searchBox'); s.value = '';
          refreshMarkers();
        });

        // Optional: Center on user if permitted
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(pos => {
            const { latitude, longitude } = pos.coords;
            map.setView([latitude, longitude], 4);
          }, () => {/* ignore */});
        }
      }

      function renderPopupHTML(p) {
        const addr = p.address ? `<div><strong>Address:</strong> ${escapeHTML(p.address)}</div>` : '';
        const url = p.url ? `<div><a href="${encodeURI(p.url)}" target="_blank" rel="noopener">Website</a></div>` : '';
        const cat = p.category ? `<div><strong>Category:</strong> ${escapeHTML(p.category)}</div>` : '';
        return `<div>
          <h3 style="margin:0 0 6px;font-size:16px;">${escapeHTML(p.name)}</h3>
          ${cat}
          ${addr}
          ${url}
        </div>`;
      }

      function escapeHTML(str = '') {
        return String(str).replace(/[&<>"]+/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
      }

      function renderCategoryPills(categories) {
        const wrap = document.getElementById('categoryPills');
        wrap.innerHTML = '';
        categories.forEach(cat => {
          const id = `cat_${cat.replace(/\W+/g, '_')}`;
          const label = document.createElement('label');
          label.className = 'pill';
          label.innerHTML = `<input type="checkbox" id="${id}" /> ${escapeHTML(cat)}`;
          wrap.appendChild(label);
          label.querySelector('input').addEventListener('change', (e) => {
            if (e.target.checked) activeCategories.add(cat); else activeCategories.delete(cat);
            refreshMarkers();
          });
        });
      }

      function refreshMarkers() {
        const q = document.getElementById('searchBox').value.trim().toLowerCase();
        clusterGroup.clearLayers();

        const allowed = allMarkers.filter(({ data }) => {
          const catPass = activeCategories.size === 0 || activeCategories.has(data.category);
          const searchPass = !q || (data.name && data.name.toLowerCase().includes(q));
          return catPass && searchPass;
        });

        allowed.forEach(({ marker }) => clusterGroup.addLayer(marker));
      }

      loadData();
    </script>

    <!--
    ===============================
    HOW TO DEPLOY ON GITHUB PAGES
    ===============================
    1) Create a repository (public ok) and add this file as index.html
    2) Create the folder: data/ and add locations.json with your points, e.g.
       [
         { "name": "Biz A", "lat": 40.7128, "lng": -74.0060, "category": "Finance", "address": "New York, USA", "url": "https://biza.example" },
         { "name": "Biz B", "lat": 51.5074, "lng": -0.1278, "category": "Tech" }
       ]
    3) In GitHub: Settings → Pages → Build and deployment → Source: Deploy from a branch → Branch: main (root)
    4) Wait for the green check, then visit: https://YOUR-USERNAME.github.io/REPO-NAME/

    Notes:
    • No API keys required (OpenStreetMap tiles). Please keep their attribution.
    • For thousands of points, keep using clustering. Consider serving points as GeoJSON.
    • You can style by category or add custom icons later.
    -->
  </body>
</html>
